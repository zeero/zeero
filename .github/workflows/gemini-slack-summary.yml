name: Gemini Slack Summary

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 22 * * *'  # 毎日日本時間7時（UTC 22時）

jobs:
  summarize-slack:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        channel: ['rss-ios', 'rss-ai', 'rss-hotentry']
    steps:
      - name: Run Gemini Slack Summary for #${{ matrix.channel }}
        uses: google-github-actions/run-gemini-cli@main
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_TEAM_ID: ${{ secrets.SLACK_TEAM_ID }}
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          upload_artifacts: true
          settings: |
            {
              "mcpServers": {
                "slack": {
                  "command": "npx",
                  "args": ["-y", "@modelcontextprotocol/server-slack"],
                  "env": {
                    "SLACK_BOT_TOKEN": "$SLACK_BOT_TOKEN",
                    "SLACK_TEAM_ID": "$SLACK_TEAM_ID"
                  }
                }
              },
              "coreTools": [
                "mcp__slack__slack_get_channel_history",
                "mcp__slack__slack_post_message"
              ]
            }
          prompt: |
            あなたは Slack の要約アシスタントです。
            この処理は定期実行しているためユーザへの確認は不要です。

            Slack チャンネル #${{ matrix.channel }} について、以下の処理を実行してください。

            1. 日本時間の昨日の間に投稿されたメッセージを取得してください。
            2. 見つかった内容を短い要約と重要なトピックの箇条書きでまとめてください。特に重要と思われる記事には100文字程度のサマリをつけてください。
            3. リンクを含める場合は Slack のリンク形式 `<URL|リンクテキスト>` を使用してください。
            4. 2でまとめた内容を、「*#${{ matrix.channel }} のサマリ*」というヘッダーを付けて Slack の `#general` チャンネルに投稿してください。
