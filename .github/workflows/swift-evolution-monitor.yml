name: Swift Evolution Monitor

on:
  workflow_dispatch:
    inputs:
      since_date:
        description: 'ç›£è¦–é–‹å§‹æ—¥ï¼ˆYYYY-MM-DDå½¢å¼ã€ç©ºã®å ´åˆã¯1æ—¥å‰ã‹ã‚‰ï¼‰'
        required: false
        default: ''
        type: string
  schedule:
    - cron: '0 6 * * *'  # æ¯æ—¥æ—¥æœ¬æ™‚é–“15æ™‚ï¼ˆUTC 6æ™‚ï¼‰

jobs:
  monitor-swift-evolution:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Get Swift Evolution Changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ç›£è¦–é–‹å§‹æ—¥ã‚’æ±ºå®š
          if [ -n "${{ github.event.inputs.since_date }}" ]; then
            # å…¥åŠ›å€¤ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆYYYY-MM-DDå½¢å¼ã®ã¿è¨±å¯ï¼‰
            INPUT_DATE="${{ github.event.inputs.since_date }}"
            if [[ ! "$INPUT_DATE" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              echo "Error: Invalid date format. Use YYYY-MM-DD format."
              exit 1
            fi
            
            # æ‰‹å‹•å®Ÿè¡Œæ™‚: æŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ã‚’æ—¥æœ¬æ™‚é–“ã¨ã—ã¦æ‰±ã„ã€UTC ã«å¤‰æ›
            JST_DATE="$INPUT_DATE 00:00:00"
            SINCE_DATE=$(TZ=Asia/Tokyo date -d "$JST_DATE" -u +"%Y-%m-%dT%H:%M:%SZ")
            echo "Manual execution: Checking commits since $INPUT_DATE JST ($SINCE_DATE UTC)"
          else
            # è‡ªå‹•å®Ÿè¡Œæ™‚: 1æ—¥å‰ã‚’ä½¿ç”¨
            SINCE_DATE=$(date -d "1 day ago" -u +"%Y-%m-%dT%H:%M:%SZ")
            echo "Scheduled execution: Checking commits since yesterday"
          fi
          
          echo "Checking commits since: $SINCE_DATE"
          
          # ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
          gh api "repos/swiftlang/swift-evolution/commits?since=${SINCE_DATE}" > commits.json
          
          # proposals ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
          echo "[]" > proposals_changes.json
          
          for sha in $(cat commits.json | jq -r '.[].sha'); do
            echo "Checking commit: $sha"
            
            # ã“ã®ã‚³ãƒŸãƒƒãƒˆã§å¤‰æ›´ã•ã‚ŒãŸ proposals ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
            gh api "repos/swiftlang/swift-evolution/commits/$sha" \
              --jq '.files[] | select(.filename | startswith("proposals/"))' \
              >> proposals_changes_temp.json
          done
          
          # å…¨ã¦ã®å¤‰æ›´ã‚’çµ±åˆï¼ˆç©ºãƒ•ã‚¡ã‚¤ãƒ«å¯¾ç­–ã‚‚å«ã‚€ï¼‰
          if [ -s proposals_changes_temp.json ]; then
            cat proposals_changes_temp.json | jq -s 'unique_by(.filename)' > proposals_changes.json
          fi
          rm -f proposals_changes_temp.json
          
          # Accept/Implement ã•ã‚ŒãŸãƒ—ãƒ­ãƒãƒ¼ã‚¶ãƒ«ã‚’ç‰¹å®š
          echo "[]" > accepted_proposals.json
          
          for filename in $(cat proposals_changes.json | jq -r '.[].filename' | sort -u); do
            echo "Checking status for: $filename"
            
            # ãƒ—ãƒ­ãƒãƒ¼ã‚¶ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’å–å¾—
            CONTENT=$(gh api "repos/swiftlang/swift-evolution/contents/$filename" --jq '.download_url' | xargs curl -s)
            
            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æŠ½å‡ºï¼ˆAccepted ã¾ãŸã¯ Implemented ã®ã¿ï¼‰
            STATUS=$(echo "$CONTENT" | grep -i "^- Status:" | head -1 | sed 's/.*Status:[[:space:]]*//' | sed 's/\*\*//g' | tr -d ' ')
            
            if [[ "$STATUS" =~ ^(Accepted|Implemented)$ ]]; then
              # ãƒ—ãƒ­ãƒãƒ¼ã‚¶ãƒ«æƒ…å ±ã‚’æŠ½å‡º
              TITLE=$(echo "$CONTENT" | grep "^#" | head -1 | sed 's/^#[[:space:]]*//')
              PROPOSAL_NUM=$(echo "$CONTENT" | grep -E "^- Proposal:" | head -1 | sed 's/.*\[\([^]]*\)\].*/\1/')
              AUTHORS=$(echo "$CONTENT" | grep "^- Authors:" | head -1 | sed 's/^- Authors:[[:space:]]*//')
              
              # JSON ã‚¨ãƒ³ãƒˆãƒªã‚’ä½œæˆ
              cat <<EOF >> accepted_proposals_temp.json
{
  "filename": "$filename",
  "status": "$STATUS",
  "title": "$TITLE",
  "proposal_number": "$PROPOSAL_NUM",
  "authors": "$AUTHORS",
  "content": $(echo "$CONTENT" | jq -Rs .)
}
EOF
              echo "Found $STATUS proposal: $PROPOSAL_NUM - $TITLE"
            fi
          done
          
          # JSON é…åˆ—ã«ã¾ã¨ã‚ã‚‹
          if [ -f accepted_proposals_temp.json ]; then
            cat accepted_proposals_temp.json | jq -s '.' > accepted_proposals.json
            rm -f accepted_proposals_temp.json
          fi
          
          echo "Accepted/Implemented proposals found:"
          cat accepted_proposals.json

      - name: Analyze and Notify
        uses: google-gemini/gemini-cli-action@main
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_TEAM_ID: ${{ secrets.SLACK_TEAM_ID }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          settings_json: |
            {
              "mcpServers": {
                "slack": {
                  "command": "npx",
                  "args": ["-y", "@modelcontextprotocol/server-slack"],
                  "env": {
                    "SLACK_BOT_TOKEN": "$SLACK_BOT_TOKEN",
                    "SLACK_TEAM_ID": "$SLACK_TEAM_ID"
                  }
                }
              },
              "coreTools": [
                "mcp__slack__slack_post_message",
                "read_file",
                "run_shell_command(cat)",
                "run_shell_command(ls)"
              ]
            }
          prompt: |
            ã‚ãªãŸã¯ Swift Evolution ãƒ—ãƒ­ãƒãƒ¼ã‚¶ãƒ«ã®è¦ç´„ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
            ã“ã®å‡¦ç†ã¯å®šæœŸå®Ÿè¡Œã—ã¦ã„ã‚‹ãŸã‚ãƒ¦ãƒ¼ã‚¶ã¸ã®ç¢ºèªã¯ä¸è¦ã§ã™ã€‚

            å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ Accept ã¾ãŸã¯ Implement ã•ã‚ŒãŸãƒ—ãƒ­ãƒãƒ¼ã‚¶ãƒ«ãŒç‰¹å®šã•ã‚Œã¦ã„ã¾ã™ã€‚
            ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æƒ…å ±ã‚’èª­ã¿å–ã£ã¦ã€è©²å½“ãƒ—ãƒ­ãƒãƒ¼ã‚¶ãƒ«ã® Slack é€šçŸ¥ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

            ## 1. å¯¾è±¡ãƒ—ãƒ­ãƒãƒ¼ã‚¶ãƒ«ã®ç¢ºèª

            ```bash
            cat accepted_proposals.json
            ```

            ## 2. Slack é€šçŸ¥ã®ä½œæˆ

            accepted_proposals.json ã«å«ã¾ã‚Œã‚‹å„ãƒ—ãƒ­ãƒãƒ¼ã‚¶ãƒ«ã«ã¤ã„ã¦ã€
            Slack ã® `#general` ãƒãƒ£ãƒ³ãƒãƒ«ã«ä»¥ä¸‹ã®å½¢å¼ã§å€‹åˆ¥ã«æŠ•ç¨¿ã—ã¦ãã ã•ã„ï¼š

            ```
            ğŸš€ Swift Evolution Update

            **{proposal_number}: {title}**
            ğŸ“‹ Status: **âœ… Accepted** ã¾ãŸã¯ **ğŸ›  Implemented**
            ğŸ‘¤ Author: {authors}
            ğŸ”— <https://github.com/swiftlang/swift-evolution/blob/main/proposals/{filename}|è©³ç´°ã‚’è¦‹ã‚‹>

            ğŸ“ **è¦ç´„:**
            [ãƒ—ãƒ­ãƒãƒ¼ã‚¶ãƒ«ã®contentãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å†…å®¹ã‚’600å­—ç¨‹åº¦ã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®è¦³ç‚¹ã‚’å«ã‚ã¦ãã ã•ã„ï¼š
            - ä½•ã‚’è§£æ±ºã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã®ã‹ï¼ˆMotivationï¼‰
            - ã©ã®ã‚ˆã†ãªè§£æ±ºç­–ã‚’ææ¡ˆã—ã¦ã„ã‚‹ã®ã‹ï¼ˆProposed Solutionï¼‰
            - Swift é–‹ç™ºè€…ã«ã¨ã£ã¦ã®ãƒ¡ãƒªãƒƒãƒˆ
            - å…·ä½“çš„ãªä½¿ç”¨ä¾‹ãŒã‚ã‚Œã°ç°¡æ½”ã«ç´¹ä»‹]
            ```

            ## 3. å¯¾è±¡å¤–ã®å ´åˆ

            accepted_proposals.json ãŒç©ºé…åˆ—ã®å ´åˆã¯ã€Slack ã¸ã®æŠ•ç¨¿ã¯è¡Œã‚ãšå‡¦ç†ã‚’çµ‚äº†ã—ã¦ãã ã•ã„ã€‚

            ## æ³¨æ„äº‹é …

            - è¤‡æ•°ã®ãƒ—ãƒ­ãƒãƒ¼ã‚¶ãƒ«ãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œãã‚Œå€‹åˆ¥ã«æŠ•ç¨¿ã™ã‚‹
            - JSONå†…ã®æƒ…å ±ã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã€æ¨æ¸¬ã‚„è£œå®Œã¯è¡Œã‚ãªã„
