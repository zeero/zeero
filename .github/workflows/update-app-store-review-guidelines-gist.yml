name: Update App Store Review Guidelines Gist

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Restore previous hash from cache
        uses: actions/cache@v4
        with:
          path: previous-hash.txt
          key: guidelines-hash-${{ github.run_id }}
          restore-keys: |
            guidelines-hash-

      - name: Fetch current guidelines
        run: curl -L https://developer.apple.com/app-store/review/guidelines/ -o guidelines.html

      - name: Calculate current hash
        run: |
          sha256sum guidelines.html | cut -d' ' -f1 > current-hash.txt
          echo "CURRENT_HASH=$(cat current-hash.txt)" >> $GITHUB_ENV

      - name: Check if guidelines changed
        run: |
          if [ -f previous-hash.txt ]; then
            PREVIOUS_HASH=$(cat previous-hash.txt)
            echo "Previous hash: $PREVIOUS_HASH"
            echo "Current hash: ${{ env.CURRENT_HASH }}"
            if [ "$PREVIOUS_HASH" != "${{ env.CURRENT_HASH }}" ]; then
              echo "GUIDELINES_CHANGED=true" >> $GITHUB_ENV
              echo "Guidelines have changed!"
            else
              echo "GUIDELINES_CHANGED=false" >> $GITHUB_ENV
              echo "No changes detected."
            fi
          else
            echo "GUIDELINES_CHANGED=true" >> $GITHUB_ENV
            echo "No previous hash found. Treating as new guidelines."
          fi

      - name: Install pandoc and GitHub CLI
        if: env.GUIDELINES_CHANGED == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc gh

      - name: Convert HTML to Markdown
        if: env.GUIDELINES_CHANGED == 'true'
        run: pandoc guidelines.html -f html -t gfm -o guidelines.md

      - name: Authenticate gh
        if: env.GUIDELINES_CHANGED == 'true'
        run: echo "${{ secrets.GH_TOKEN }}" | gh auth login --with-token

      - name: Fetch previous guidelines from Gist
        if: env.GUIDELINES_CHANGED == 'true'
        env:
          GIST_ID: ${{ secrets.GIST_ID }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: gh gist view "$GIST_ID" -f guidelines.md > previous_guidelines.md || touch previous_guidelines.md

      - name: Update gist
        if: env.GUIDELINES_CHANGED == 'true'
        env:
          GIST_ID: ${{ secrets.GIST_ID }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: gh gist edit "$GIST_ID" guidelines.md

      - name: Generate diff
        if: env.GUIDELINES_CHANGED == 'true'
        run: diff -u previous_guidelines.md guidelines.md > guidelines.diff || true

      - name: Analyze and Notify
        if: env.GUIDELINES_CHANGED == 'true'
        uses: google-github-actions/run-gemini-cli@main
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_TEAM_ID: ${{ secrets.SLACK_TEAM_ID }}
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: "gemini-1.5-flash"
          upload_artifacts: true
          settings_json: |
            {
              "mcpServers": {
                "slack": {
                  "command": "npx",
                  "args": ["-y", "@modelcontextprotocol/server-slack"],
                  "env": {
                    "SLACK_BOT_TOKEN": "$SLACK_BOT_TOKEN",
                    "SLACK_TEAM_ID": "$SLACK_TEAM_ID"
                  }
                }
              },
              "coreTools": [
                "mcp__slack__slack_post_message",
                "read_file"
              ]
            }
          prompt: |
            ã‚ãªãŸã¯ App Store Review Guidelines ã®æ›´æ–°ã‚’ç›£è¦–ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
            Apple ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚

            ä»¥ä¸‹ã® diff ãƒ•ã‚¡ã‚¤ãƒ«ã¨æ–°ã—ã„ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®å†…å®¹ã‚’åˆ†æã—ã¦ã€å¤‰æ›´å†…å®¹ã‚’æ—¥æœ¬èªã§è¦ç´„ã—ã€Slack ã® `#general` ãƒãƒ£ãƒ³ãƒãƒ«ã«æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚

            - guidelines.diff (å¤‰æ›´ç‚¹)
            - guidelines.md (æ–°ã—ã„å†…å®¹)

            é€šçŸ¥ã®å½¢å¼ï¼š
            ğŸš€ **App Store Review Guidelines ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ**

            ğŸ“ **å¤‰æ›´ã®è¦ç´„:**
            [å¤‰æ›´ç‚¹ã‚’ç®‡æ¡æ›¸ãã§åˆ†ã‹ã‚Šã‚„ã™ãè¨˜è¿°ã—ã¦ãã ã•ã„ã€‚ã©ã®ã‚ˆã†ãªå½±éŸ¿ãŒã‚ã‚‹ã‹ã‚‚å«ã‚ã¦ãã ã•ã„ã€‚]

            ğŸ”— <https://developer.apple.com/app-store/review/guidelines/|ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³åŸæ–‡>
            ğŸ”— <https://gist.github.com/${{ secrets.GIST_ID }}|Gist ã§å·®åˆ†ã‚’ç¢ºèª>

      - name: Save current hash for next run
        if: env.GUIDELINES_CHANGED == 'true'
        run: cp current-hash.txt previous-hash.txt

      - name: No update needed
        if: env.GUIDELINES_CHANGED != 'true'
        run: echo 'No guidelines changes detected. Workflow completed.'
