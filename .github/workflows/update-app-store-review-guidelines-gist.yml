name: Update App Store Review Guidelines Gist

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Restore previous date from cache
        uses: actions/cache@v4
        with:
          path: previous-date.txt
          key: guidelines-date-${{ github.run_id }}
          restore-keys: |
            guidelines-date-

      - name: Fetch current guidelines
        run: curl -L https://developer.apple.com/app-store/review/guidelines/ -o guidelines.html

      - name: Extract Last Updated line
        run: |
          # HTML„Åã„Çâ "Last Updated:" „ÇíÂê´„ÇÄË°åÂÖ®‰Ωì„ÇíÊäΩÂá∫
          CURRENT_DATE=$(grep "Last Updated:" guidelines.html || echo "")
          if [ -z "$CURRENT_DATE" ]; then
            echo "Error: Could not find 'Last Updated' line in HTML"
            exit 1
          fi
          echo "$CURRENT_DATE" > current-date.txt
          echo "CURRENT_DATE=$CURRENT_DATE" >> $GITHUB_ENV
          echo "Current Last Updated line: $CURRENT_DATE"

      - name: Check if guidelines changed
        run: |
          if [ -f previous-date.txt ]; then
            PREVIOUS_DATE=$(cat previous-date.txt)
            echo "Previous Last Updated: $PREVIOUS_DATE"
            echo "Current Last Updated: ${{ env.CURRENT_DATE }}"
            if [ "$PREVIOUS_DATE" != "${{ env.CURRENT_DATE }}" ]; then
              echo "GUIDELINES_CHANGED=true" >> $GITHUB_ENV
              echo "Guidelines have changed!"
            else
              echo "GUIDELINES_CHANGED=false" >> $GITHUB_ENV
              echo "No changes detected (same Last Updated date)."
            fi
          else
            echo "GUIDELINES_CHANGED=true" >> $GITHUB_ENV
            echo "No previous date found. Treating as new guidelines."
          fi

      - name: Install pandoc and GitHub CLI
        if: env.GUIDELINES_CHANGED == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc gh

      - name: Convert HTML to Markdown
        if: env.GUIDELINES_CHANGED == 'true'
        run: pandoc guidelines.html -f html -t gfm -o guidelines.md

      - name: Authenticate gh
        if: env.GUIDELINES_CHANGED == 'true'
        run: echo "${{ secrets.GH_TOKEN }}" | gh auth login --with-token

      - name: Update gist
        if: env.GUIDELINES_CHANGED == 'true'
        env:
          GIST_ID: ${{ secrets.GIST_ID }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: gh gist edit "$GIST_ID" guidelines.md

      - name: Notify Slack
        if: env.GUIDELINES_CHANGED == 'true'
        run: |
          MESSAGE="üöÄ *App Store Review Guidelines „ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü*\n\nüîó <https://developer.apple.com/app-store/review/guidelines/|„Ç¨„Ç§„Éâ„É©„Ç§„É≥ÂéüÊñá>\nüîó <https://gist.github.com/${{ secrets.GIST_ID }}|Gist „ÅßÂ∑ÆÂàÜ„ÇíÁ¢∫Ë™ç>"
          curl -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"channel\":\"#general\",\"text\":\"$MESSAGE\"}"

      - name: Save current date for next run
        if: env.GUIDELINES_CHANGED == 'true'
        run: cp current-date.txt previous-date.txt

      - name: No update needed
        if: env.GUIDELINES_CHANGED != 'true'
        run: echo 'No guidelines changes detected. Workflow completed.'
