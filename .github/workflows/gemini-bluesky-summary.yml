name: Gemini Bluesky Summary

on:
  workflow_dispatch: {}
  schedule:
    - cron: '10 22 * * *'

jobs:
  summarize-bluesky:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Install pnpm if needed
        run: |
          if ! command -v pnpm >/dev/null 2>&1; then
            npm install -g pnpm
          fi
      - name: Install Bluesky MCP server
        run: |
          git clone https://github.com/brianellin/bsky-mcp-server.git
          cd bsky-mcp-server
          pnpm install
          pnpm run build
          echo "BLSKY_MCP_PATH=$PWD/build/src/index.js" >> $GITHUB_ENV

      - name: Run Gemini Bluesky Summary
        uses: google-github-actions/run-gemini-cli@main
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_TEAM_ID: ${{ secrets.SLACK_TEAM_ID }}
          BLUESKY_IDENTIFIER: ${{ secrets.BLUESKY_IDENTIFIER }}
          BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}
          BLUESKY_SERVICE_URL: ${{ secrets.BLUESKY_SERVICE_URL }}
          BLSKY_MCP_PATH: ${{ env.BLSKY_MCP_PATH }}
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: "gemini-2.5-flash"
          upload_artifacts: true
          settings: |
            {
              "mcpServers": {
                "slack": {
                  "command": "npx",
                  "args": ["-y", "@modelcontextprotocol/server-slack"],
                  "env": {
                    "SLACK_BOT_TOKEN": "$SLACK_BOT_TOKEN",
                    "SLACK_TEAM_ID": "$SLACK_TEAM_ID"
                  }
                },
                "bluesky": {
                  "command": "node",
                  "args": ["$BLSKY_MCP_PATH"],
                  "env": {
                    "BLUESKY_IDENTIFIER": "$BLUESKY_IDENTIFIER",
                    "BLUESKY_APP_PASSWORD": "$BLUESKY_APP_PASSWORD",
                    "BLUESKY_SERVICE_URL": "$BLUESKY_SERVICE_URL"
                  }
                }
              },
              "coreTools": [
                "mcp__bluesky__get_feed_posts"
              ]
            }
          prompt: |
            ã‚ãªãŸã¯ Bluesky æŠ•ç¨¿ã®ã¾ã¨ã‚ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
            ã“ã®å‡¦ç†ã¯å®šæœŸå®Ÿè¡Œã—ã¦ã„ã‚‹ãŸã‚ãƒ¦ãƒ¼ã‚¶ã¸ã®ç¢ºèªã¯ä¸è¦ã§ã™ã€‚
            `mcp__bluesky__get_feed_posts` ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã„ã€
            ãƒ•ã‚£ãƒ¼ãƒ‰ URI `at://did:plc:a3vurmxtfdiehvyefas744uc/app.bsky.feed.generator/aaalzlquduqha` ã‹ã‚‰æŠ•ç¨¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚
            1. ç›´è¿‘24æ™‚é–“ã«æŠ•ç¨¿ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
            2. èª­ã¿è¾¼ã‚“ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦ç´„ã—ã¦ãã ã•ã„ã€‚
            3. ã„ã„ã­æ•°ãŒå¤šã„ã‚‚ã®ã‚„ iOS é–‹ç™ºè€…ã«æœ‰ç›Šãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’5ä»¶é¸ã³ã€é‡è¦åº¦é †ã«ä»¥ä¸‹ã‚’åˆ—æŒ™ã—ã¦ãã ã•ã„ã€‚
               - <ãƒ¦ãƒ¼ã‚¶å|ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯URL> ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æŠ•ç¨¿æ™‚é–“ ğŸ‘ã„ã„ã­æ•°
                 - Slackã®ãƒªãƒ³ã‚¯å½¢å¼ã«ã—ã¦ãã ã•ã„
            4. 2ã®ã‚µãƒãƒªã¨3ã®çµæœã‚’ Slack ã® `#general` ãƒãƒ£ãƒ³ãƒãƒ«ã«æŠ•ç¨¿ã—ã¾ã™ã€‚
      - name: Upload Gemini Error Log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gemini-error-log
          path: /tmp/gemini-client-error-*.json
