name: Gemini Bluesky Summary

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 23 * * *'

jobs:
  summarize-bluesky:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Run Gemini Bluesky Summary
        uses: google-gemini/gemini-cli-action@main
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_TEAM_ID: ${{ secrets.SLACK_TEAM_ID }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          settings_json: |
            {
              "mcpServers": {
                "slack": {
                  "command": "npx",
                  "args": ["-y", "@modelcontextprotocol/server-slack"],
                  "env": {
                    "SLACK_BOT_TOKEN": "$SLACK_BOT_TOKEN",
                    "SLACK_TEAM_ID": "$SLACK_TEAM_ID"
                  }
                }
              },
              "coreTools": [
                "run_shell_command(curl)"
              ]
            }
          prompt: >-
            あなたは Bluesky 投稿のまとめアシスタントです。
            `curl -sL
            https://bsky.app/profile/did:plc:a3vurmxtfdiehvyefas744uc/feed/aaalzlquduqha`
            を実行し、HTML を取得してください。
            1. 日本時間の昨日投稿されたメッセージを抽出してください。
            2. いいね数が多い順に上位5件を選び、各メッセージ本文といいね数をそのまま列挙してください。要約は不要です。
            3. 結果を Slack の `#general` チャンネルに投稿します。
